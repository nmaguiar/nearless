log_format ndjson escape=json
'{'
    '"@timestamp":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"remote_user":"$remote_user",'
    '"request":"$request",'
    '"status":"$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"http_referer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"http_x_forwarded_for":"$http_x_forwarded_for",'
    '"request_time":"$request_time",'
    '"upstream_response_time":"$upstream_response_time",'
    '"upstream_addr":"$upstream_addr"'
'}';

access_log /dev/stdout ndjson;
error_log /dev/stderr warn;

{{#each sites}}
# Name: {{name}}
# Source: {{source}}
# Target: {{{$toSLON target}}}
#
{{#each target}}
upstream backend_{{../name}}_{{i}} {
    server {{to}};
    server 127.0.0.1:7777 backup;
}
{{/each}}

server {
    listen 8080;

    server_name {{source}};

    {{#each target}}
    location {{path}} {
        {{#if rewrite}}rewrite ^{{path}}/?(.*)$ /$1 break;{{/if}}
        proxy_pass http://backend_{{../name}}_{{i}};
        client_max_body_size 100M;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $http_x_forwarded_for,$remote_addr;
        proxy_set_header X-Forwarded-For $http_x_forwarded_for;
        #proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto$scheme;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        #proxy_set_header X-Forwarded-Host $http_x_forwarded_host$host;
        proxy_set_header X-Forwarded-Host $http_x_forwarded_host;
        #proxy_set_header X-Forwarded-Port $http_x_forwarded_port$server_port;
        proxy_set_header X-Forwarded-Port $http_x_forwarded_port;
    }
    {{/each}}
}

{{/each}}